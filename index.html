<!DOCTYPE html>
<html>
<head>
    <title>Theo D√µi G·∫≠y Th√¥ng Minh - Gi√°m H·ªô</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; }
        #map { flex-grow: 1; height: 100%; z-index: 1; }
        #control-panel { padding: 10px; background: #f4f4f4; border-bottom: 1px solid #ddd; z-index: 2; }
        #status-group { display: flex; justify-content: space-between; margin-top: 5px; flex-wrap: wrap; gap: 10px; }
        .status-box { padding: 5px 10px; border-radius: 4px; font-size: 0.9em; }
        #locationStatus { background-color: #e0f7fa; border: 1px solid #b2ebf2; }
        #configStatus { background-color: #fff3e0; border: 1px solid #ffcc80; }
        h3 { margin-top: 0; margin-bottom: 5px; }
        .input-group { margin-bottom: 10px; }
        .input-group label { display: inline-block; width: 150px; }
        .input-group input { width: 250px; padding: 5px; }
        .input-group button { padding: 5px 15px; margin-left: 5px; cursor: pointer; }
        .success { background-color: #d4edda !important; border-color: #c3e6cb !important; color: #155724; }
        .error { background-color: #f8d7da !important; border-color: #f5c6cb !important; color: #721c24; }
    </style>
</head>
<body>
    <div id="control-panel">
        <h3>üó∫Ô∏è Theo D√µi & üìû C·∫•u H√¨nh G·∫≠y</h3>
        
        <!-- URL Google Apps Script -->
        <input type="hidden" id="apiUrlInput" value="https://script.google.com/macros/s/AKfycby01JlYgjRFUiAZSl37AIP71sqndN4OI917Vx-hg3jod6wgdtKcjDO4Bqwk4xePi8DN/exec">
        
        <!-- Tracking Control -->
        <div class="input-group">
            <label for="phoneInput">S·ªë ƒêT (ID Thi·∫øt B·ªã):</label>
            <input type="text" id="phoneInput" value="+84976537914" readonly style="border: none; background: #eee;">
            <button onclick="startTracking()">B·∫Øt ƒê·∫ßu Theo D√µi</button>
            <button onclick="stopTracking()">D·ª´ng</button>
        </div>

        <!-- Update Emergency Phone -->
        <div class="input-group" style="border-top: 1px solid #ccc; padding-top: 10px;">
            <label for="newPhoneInput">C·∫≠p nh·∫≠t SƒêT Kh·∫©n c·∫•p:</label>
            <input type="text" id="newPhoneInput" placeholder="+84...">
            <button onclick="updateEmergencyPhone()">C·∫≠p nh·∫≠t SOS</button>
        </div>
        
        <!-- Status Display -->
        <div id="status-group">
            <span id="locationStatus" class="status-box">V·ªã tr√≠: ƒêang ch·ªù...</span>
            <span id="configStatus" class="status-box">ƒêang t·∫£i c·∫•u h√¨nh...</span>
        </div>
    </div>
    
    <div id="map"></div>

    <script>
        // Configuration
        const GOOGLE_SHEET_API_URL = document.getElementById('apiUrlInput').value;
        const TRACKING_INTERVAL = 5000; // 5 gi√¢y

        // Map initialization
        var map = L.map('map').setView([16.0, 108.0], 5);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '¬© OpenStreetMap'
        }).addTo(map);

        var userMarker = null;
        var trackingTimer = null;

        // --- H√ÄM C·∫¨P NH·∫¨T MARKER ---
        function updateMarker(lat, lng, timestamp) {
            var newLatLng = new L.LatLng(lat, lng);
            
            if (userMarker === null) {
                userMarker = L.marker(newLatLng).addTo(map);
            } else {
                userMarker.setLatLng(newLatLng);
            }

            const timeStr = new Date(timestamp).toLocaleTimeString('vi-VN');
            const dateStr = new Date(timestamp).toLocaleDateString('vi-VN');
            
            userMarker.setPopupContent(`
                <b>V·ªã tr√≠ Ng∆∞·ªùi d√πng</b><br>
                C·∫≠p nh·∫≠t l√∫c: ${timeStr} ${dateStr}<br>
                T·ªça ƒë·ªô: ${lat}, ${lng}
            `).openPopup();
            
            map.setView(newLatLng, 15);
            document.getElementById('locationStatus').innerText = `V·ªã tr√≠: M·ªõi nh·∫•t @ ${timeStr}`;
            document.getElementById('locationStatus').className = 'status-box success';
        }

        // --- L·∫§Y V·ªä TR√ç M·ªöI NH·∫§T (GET only) ---
        async function fetchLatestLocation() {
            const apiUrl = `${GOOGLE_SHEET_API_URL}?action=getLatest&_=${Date.now()}`;
            const locationStatus = document.getElementById('locationStatus');
            
            try {
                const response = await fetch(apiUrl);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.status === 'success' && result.data.lat && result.data.lng) {
                    const { lat, lng, timestamp } = result.data;
                    
                    if (!userMarker || userMarker.getLatLng().lat != lat || userMarker.getLatLng().lng != lng) {
                        updateMarker(lat, lng, timestamp);
                    }
                } else {
                    locationStatus.innerText = 'V·ªã tr√≠: Ch∆∞a c√≥ d·ªØ li·ªáu GPS.';
                    locationStatus.className = 'status-box';
                }
            } catch (error) {
                locationStatus.innerText = 'V·ªã tr√≠: L·ªñI K·∫æT N·ªêI!';
                locationStatus.className = 'status-box error';
                console.error("L·ªói fetch v·ªã tr√≠:", error);
            }
        }

        // --- L·∫§Y C·∫§U H√åNH (GET only) ---
        async function fetchConfig() {
            const configStatusDiv = document.getElementById('configStatus');
            const apiUrl = `${GOOGLE_SHEET_API_URL}?action=getConfig&_=${Date.now()}`;
            
            try {
                const response = await fetch(apiUrl);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.status === 'success' && result.data.EMERGENCY_PHONE) {
                    const phone = result.data.EMERGENCY_PHONE;
                    configStatusDiv.innerText = `SƒêT Kh·∫©n c·∫•p: ${phone}`;
                    configStatusDiv.className = 'status-box success';
                    document.getElementById('newPhoneInput').value = phone;
                } else {
                    configStatusDiv.innerText = 'SƒêT: L·ªói t·∫£i!';
                    configStatusDiv.className = 'status-box error';
                }
            } catch (error) {
                configStatusDiv.innerText = 'SƒêT: L·ªñI K·∫æT N·ªêI!';
                configStatusDiv.className = 'status-box error';
                console.error("L·ªói fetch config:", error);
            }
        }

        // --- C·∫¨P NH·∫¨T S·ªê KH·∫®N C·∫§P (GET only - tr√°nh CORS) ---
        async function updateEmergencyPhone() {
            const newPhone = document.getElementById('newPhoneInput').value.trim();
            const configStatusDiv = document.getElementById('configStatus');
            
            if (!newPhone || !newPhone.startsWith('+')) {
                alert("Vui l√≤ng nh·∫≠p s·ªë ƒëi·ªán tho·∫°i h·ª£p l·ªá, b·∫Øt ƒë·∫ßu b·∫±ng + (v√≠ d·ª•: +84...)");
                return;
            }
            
            configStatusDiv.innerText = 'ƒêang c·∫≠p nh·∫≠t...';
            configStatusDiv.className = 'status-box';

            try {
                // S·ª¨ D·ª§NG GET thay v√¨ POST ƒë·ªÉ tr√°nh CORS
                const apiUrl = `${GOOGLE_SHEET_API_URL}?action=updateConfig&newPhone=${encodeURIComponent(newPhone)}&_=${Date.now()}`;
                
                const response = await fetch(apiUrl);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    configStatusDiv.innerText = `‚úÖ C·∫≠p nh·∫≠t th√†nh c√¥ng: ${newPhone}`;
                    configStatusDiv.className = 'status-box success';
                    
                    // ƒê·ª£i 1 gi√¢y r·ªìi verify
                    setTimeout(() => {
                        fetchConfig();
                    }, 1000);
                } else {
                    configStatusDiv.innerText = `‚ùå L·ªói: ${result.data}`;
                    configStatusDiv.className = 'status-box error';
                }
                
            } catch (error) {
                configStatusDiv.innerText = '‚ùå L·ªói k·∫øt n·ªëi Google Sheet!';
                configStatusDiv.className = 'status-box error';
                console.error("L·ªói update phone:", error);
            }
        }

        // --- KH·ªûI ƒê·ªòNG TRACKING ---
        function startTracking() {
            if (trackingTimer) {
                clearInterval(trackingTimer);
            }
            
            console.log('B·∫Øt ƒë·∫ßu theo d√µi...');
            
            // L·∫•y v·ªã tr√≠ v√† config l·∫ßn ƒë·∫ßu
            fetchLatestLocation();
            fetchConfig();
            
            // Thi·∫øt l·∫≠p h·∫πn gi·ªù
            trackingTimer = setInterval(fetchLatestLocation, TRACKING_INTERVAL);
            
            alert('‚úÖ ƒê√£ b·∫Øt ƒë·∫ßu theo d√µi!');
        }

        function stopTracking() {
            if (trackingTimer) {
                clearInterval(trackingTimer);
                trackingTimer = null;
                console.log('D·ª´ng theo d√µi');
                alert('‚è∏Ô∏è ƒê√£ d·ª´ng theo d√µi!');
            }
        }

        // T·ª± ƒë·ªông b·∫Øt ƒë·∫ßu khi load
        window.onload = function() {
            console.log('Page loaded, auto-starting...');
            startTracking();
        };
    </script>
</body>
</html>
