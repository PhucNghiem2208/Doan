<!DOCTYPE html>
<html>
<head>
    <title>Theo D√µi G·∫≠y Th√¥ng Minh - Gi√°m H·ªô</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; }
        #map { flex-grow: 1; height: 100%; z-index: 1; }
        #control-panel { padding: 10px; background: #f4f4f4; border-bottom: 1px solid #ddd; z-index: 2; }
        #status-group { display: flex; justify-content: space-between; margin-top: 5px; }
        .status-box { padding: 5px 10px; border-radius: 4px; font-size: 0.9em; }
        #locationStatus { background-color: #e0f7fa; border: 1px solid #b2ebf2; }
        #configStatus { background-color: #fff3e0; border: 1px solid #ffcc80; }
        h3 { margin-top: 0; margin-bottom: 5px; }
    </style>
</head>
<body>
    <div id="control-panel">
        <h3>üìç Theo D√µi & üìû C·∫•u H√¨nh G·∫≠y</h3>
        
        <input type="hidden" id="apiUrlInput" value="https://script.google.com/macros/s/AKfycbxQfPB3Mn0hlzBlFwf-_SMC58sDAMepYMZvkAO6YAWAvzK39oPyabbkhoQjYSslYlIh/exec"> 
        
        <div style="margin-bottom: 10px;">
            <label for="phoneInput">S·ªë ƒêT (ID Thi·∫øt B·ªã):</label>
            <input type="text" id="phoneInput" value="+84976537914" readonly style="border: none; background: #eee;">
            <button onclick="startTracking()">B·∫Øt ƒê·∫ßu Theo D√µi</button>
        </div>

        <div style="border-top: 1px solid #ccc; padding-top: 10px;">
            <label for="newPhoneInput">C·∫≠p nh·∫≠t SƒêT Kh·∫©n c·∫•p:</label>
            <input type="text" id="newPhoneInput" placeholder="+84...">
            <button onclick="updateEmergencyPhone()">C·∫≠p nh·∫≠t SOS</button>
            <span id="configStatus" class="status-box">ƒêang t·∫£i c·∫•u h√¨nh...</span>
        </div>
        
        <div id="status-group">
            <span id="locationStatus" class="status-box">V·ªã tr√≠: ƒêang ch·ªù...</span>
        </div>
    </div>
    
    <div id="map"></div>

    <script>
        // L·∫•y URL t·ª´ input ·∫©n (THAY TH·∫æ CH·ªñ N√ÄY)
        const GOOGLE_SHEET_API_URL = document.getElementById('apiUrlInput').value;
        const TRACKING_INTERVAL = 5000; // C·∫≠p nh·∫≠t v·ªã tr√≠ m·ªói 5 gi√¢y

        var map = L.map('map').setView([16.0, 108.0], 5); // V·ªã tr√≠ m·∫∑c ƒë·ªãnh ·ªü Vi·ªát Nam
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '¬© OpenStreetMap'
        }).addTo(map);

        var userMarker = null;
        var trackingTimer = null;
        var trackedPhone = document.getElementById('phoneInput').value;

        // --- H√ÄM 1: C·∫¨P NH·∫¨T V·ªä TR√ç TR√äN B·∫¢N ƒê·ªí ---
        function updateMarker(lat, lng, timestamp) {
            var newLatLng = new L.LatLng(lat, lng);
            
            if (userMarker === null) {
                userMarker = L.marker(newLatLng).addTo(map);
            } else {
                userMarker.setLatLng(newLatLng);
            }

            const timeStr = new Date(timestamp).toLocaleTimeString('vi-VN');
            const dateStr = new Date(timestamp).toLocaleDateString('vi-VN');
            
            userMarker.setPopupContent(`
                <b>V·ªã tr√≠ Ng∆∞·ªùi d√πng</b><br>
                C·∫≠p nh·∫≠t l√∫c: ${timeStr} ${dateStr}<br>
                T·ªça ƒë·ªô: ${lat}, ${lng}
            `).openPopup();
            
            map.setView(newLatLng, 15);
            document.getElementById('locationStatus').innerText = `V·ªã tr√≠: M·ªõi nh·∫•t @ ${timeStr}`;
        }

        // --- H√ÄM 2: L·∫§Y V·ªä TR√ç M·ªöI NH·∫§T T·ª™ SHEET (GET) ---
        async function fetchLatestLocation() {
            const apiUrl = `${GOOGLE_SHEET_API_URL}?action=getLatest`;
            try {
                const response = await fetch(apiUrl);
                const result = await response.json();
                
                if (result.status === 'success' && result.data.lat && result.data.lng) {
                    const { lat, lng, timestamp } = result.data;
                    // Ch·ªâ c·∫≠p nh·∫≠t n·∫øu t·ªça ƒë·ªô m·ªõi kh√°c t·ªça ƒë·ªô marker hi·ªán t·∫°i
                    if (!userMarker || userMarker.getLatLng().lat != lat || userMarker.getLatLng().lng != lng) {
                        updateMarker(lat, lng, timestamp);
                    }
                } else {
                    document.getElementById('locationStatus').innerText = 'V·ªã tr√≠: Ch∆∞a c√≥ d·ªØ li·ªáu GPS.';
                }
            } catch (error) {
                document.getElementById('locationStatus').innerText = 'V·ªã tr√≠: L·ªñI K·∫æT N·ªêI API!';
                console.error("L·ªói khi fetch v·ªã tr√≠:", error);
            }
        }

        // --- H√ÄM 3: L·∫§Y C·∫§U H√åNH SOS HI·ªÜN T·∫†I (GET) ---
        async function fetchConfig() {
            const configStatusDiv = document.getElementById('configStatus');
            const apiUrl = `${GOOGLE_SHEET_API_URL}?action=getConfig`;
            try {
                const response = await fetch(apiUrl);
                const result = await response.json();
                
                if (result.status === 'success' && result.data.EMERGENCY_PHONE) {
                    const phone = result.data.EMERGENCY_PHONE;
                    configStatusDiv.innerText = `SƒêT Kh·∫©n c·∫•p: ${phone}`;
                    document.getElementById('newPhoneInput').value = phone; // ƒêi·ªÅn v√†o √¥ input
                } else {
                    configStatusDiv.innerText = 'SƒêT Kh·∫©n c·∫•p: L·ªói t·∫£i c·∫•u h√¨nh!';
                }
            } catch (error) {
                configStatusDiv.innerText = 'SƒêT Kh·∫©n c·∫•p: L·ªñI K·∫æT N·ªêI API!';
                console.error("L·ªói khi fetch c·∫•u h√¨nh:", error);
            }
        }


        // --- H√ÄM 4: C·∫¨P NH·∫¨T S·ªê SOS L√äN SHEET (POST) ---
        async function updateEmergencyPhone() {
            const newPhone = document.getElementById('newPhoneInput').value.trim();
            const configStatusDiv = document.getElementById('configStatus');
            
            if (!newPhone || !newPhone.startsWith('+')) {
                alert("Vui l√≤ng nh·∫≠p s·ªë ƒëi·ªán tho·∫°i h·ª£p l·ªá, b·∫Øt ƒë·∫ßu b·∫±ng m√£ qu·ªëc gia (v√≠ d·ª•: +84...).");
                return;
            }
            
            configStatusDiv.innerText = 'ƒêang g·ª≠i y√™u c·∫ßu c·∫≠p nh·∫≠t...';

            try {
                const response = await fetch(GOOGLE_SHEET_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'updateConfig',
                        newPhone: newPhone
                    })
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    configStatusDiv.innerText = `C·∫≠p nh·∫≠t th√†nh c√¥ng: ${newPhone}`;
                } else {
                    configStatusDiv.innerText = `L·ªói c·∫≠p nh·∫≠t: ${result.data}`;
                    console.error("L·ªói c·∫≠p nh·∫≠t c·∫•u h√¨nh:", result);
                }
            } catch (error) {
                configStatusDiv.innerText = 'L·ªói k·∫øt n·ªëi API Google Sheet.';
            }
        }
        
        // --- H√ÄM CH√çNH KH·ªûI ƒê·ªòNG ---
        function startTracking() {
            if (trackingTimer) {
                clearInterval(trackingTimer);
            }
            
            // 1. L·∫•y v·ªã tr√≠ l·∫ßn ƒë·∫ßu
            fetchLatestLocation();
            
            // 2. Thi·∫øt l·∫≠p h·∫πn gi·ªù c·∫≠p nh·∫≠t v·ªã tr√≠
            trackingTimer = setInterval(fetchLatestLocation, TRACKING_INTERVAL);
            
            // 3. L·∫•y c·∫•u h√¨nh ban ƒë·∫ßu
            fetchConfig();
        }

        // B·∫Øt ƒë·∫ßu theo d√µi khi trang t·∫£i xong
        window.onload = startTracking; 

    </script>
</body>

</html>
